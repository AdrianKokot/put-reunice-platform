<ng-container *tuiLet="item$ | async as item">
  <ng-container
    *tuiLet="(editingOwnAccount$ | async) ?? false as editingOwnAccount"
  >
    <form
      *tuiLet="(allFieldsReadonly$ | async) ?? false as readOnly"
      [formGroup]="handler.form"
      [class.form-skeleton]="item === null"
      (ngSubmit)="handler.submit()"
    >
      <h3 class="tui-form__header">
        {{ 'BASIC_INFORMATION' | translate }}
      </h3>

      <div class="tui-form__row tui-form__row_multi-fields">
        <label
          [tuiLabel]="'FIRST_NAME' | translate"
          class="tui-form__multi-field"
        >
          <tui-input
            formControlName="firstName"
            tuiTextfieldSize="m"
            [tuiTextfieldLabelOutside]="true"
            [readOnly]="readOnly"
          >
            <input tuiTextfield type="text" />
          </tui-input>

          <tui-error
            formControlName="firstName"
            [error]="[] | tuiFieldError | async"
          ></tui-error>
        </label>

        <label
          [tuiLabel]="'LAST_NAME' | translate"
          class="tui-form__multi-field"
        >
          <tui-input
            formControlName="lastName"
            tuiTextfieldSize="m"
            [tuiTextfieldLabelOutside]="true"
            [readOnly]="readOnly"
          >
            <input tuiTextfield type="text" />
          </tui-input>

          <tui-error
            formControlName="lastName"
            [error]="[] | tuiFieldError | async"
          ></tui-error>
        </label>
      </div>

      <div class="tui-form__row tui-form__row_multi-fields">
        <label [tuiLabel]="'EMAIL' | translate" class="tui-form__multi-field">
          <tui-input
            formControlName="email"
            tuiTextfieldSize="m"
            [tuiTextfieldLabelOutside]="true"
            [readOnly]="readOnly"
          >
            <input tuiTextfield type="email" />
          </tui-input>

          <tui-error
            formControlName="email"
            [error]="[] | tuiFieldError | async"
          ></tui-error>
        </label>

        <label
          [tuiLabel]="'PHONE_NUMBER' | translate"
          class="tui-form__multi-field"
        >
          <tui-input
            formControlName="phoneNumber"
            tuiTextfieldSize="m"
            [tuiTextfieldLabelOutside]="true"
            [readOnly]="readOnly"
          >
            <input tuiTextfield type="tel" />
          </tui-input>

          <tui-error
            formControlName="phoneNumber"
            [error]="[] | tuiFieldError | async"
          ></tui-error>
        </label>
      </div>

      <h3 class="tui-form__header">
        {{ 'ACCOUNT_INFORMATION' | translate }}
      </h3>

      <label [tuiLabel]="'USERNAME' | translate" class="tui-form__row">
        <tui-input
          formControlName="username"
          tuiTextfieldSize="m"
          [tuiTextfieldLabelOutside]="true"
          [readOnly]="readOnly"
        >
          <input tuiTextfield type="text" />
        </tui-input>

        <tui-error
          formControlName="username"
          [error]="[] | tuiFieldError | async"
        ></tui-error>
      </label>

      <div class="tui-form__row tui-form__row_multi-fields">
        <label [tuiLabel]="'STATE' | translate" class="tui-form__multi-field">
          <tui-select
            formControlName="enabled"
            tuiTextfieldSize="m"
            [valueContent]="stateValueContent"
            [tuiTextfieldLabelOutside]="true"
            [readOnly]="readOnly || editingOwnAccount"
            [tuiHint]="
              editingOwnAccount
                ? ('CANNOT_DEACTIVATE_OWN_ACCOUNT' | translate)
                : undefined
            "
          >
            <tui-data-list *tuiDataList>
              <button tuiOption [value]="true">
                {{ 'ACTIVE' | translate }}
              </button>
              <button tuiOption [value]="false">
                {{ 'DEACTIVATED' | translate }}
              </button>
            </tui-data-list>
          </tui-select>

          <ng-template #stateValueContent let-item>
            {{ (item ? 'ACTIVE' : 'DEACTIVATED') | translate }}
          </ng-template>

          <tui-error
            formControlName="enabled"
            [error]="[] | tuiFieldError | async"
          ></tui-error>
        </label>

        <label [tuiLabel]="'ROLE' | translate" class="tui-form__multi-field">
          <tui-select
            formControlName="accountType"
            tuiTextfieldSize="m"
            [valueContent]="accountTypeValueContent"
            [tuiTextfieldLabelOutside]="true"
            [readOnly]="readOnly"
          >
            <tui-data-list *tuiDataList>
              <button
                tuiOption
                [value]="accountType.ADMIN"
                *reuniceUser="accountType.ADMIN"
              >
                {{ 'ACCOUNT_TYPE_' + accountType.ADMIN | translate }}
              </button>
              <button tuiOption [value]="accountType.MODERATOR">
                {{ 'ACCOUNT_TYPE_' + accountType.MODERATOR | translate }}
              </button>
              <button tuiOption [value]="accountType.USER">
                {{ 'ACCOUNT_TYPE_' + accountType.USER | translate }}
              </button>
            </tui-data-list>
          </tui-select>

          <ng-template #accountTypeValueContent let-item>
            {{ 'ACCOUNT_TYPE_' + item | translate }}
          </ng-template>

          <tui-error
            formControlName="accountType"
            [error]="[] | tuiFieldError | async"
          ></tui-error>
        </label>
      </div>

      <label
        [tuiLabel]="'ENROLLED_UNIVERSITIES' | translate"
        class="tui-form__row"
        *ngIf="
          form.controls.accountType.value &&
          form.controls.accountType.value !== accountType.ADMIN
        "
      >
        <tui-combo-box
          tuiTextfieldSize="m"
          *tuiLet="universitySearch.itemIds$ | async as items"
          formControlName="enrolledUniversities"
          [tuiTextfieldLabelOutside]="true"
          (searchChange)="universitySearch.search($event)"
          [stringify]="(universitySearch.stringify$ | async)!"
          [readOnly]="readOnly"
        >
          <tui-data-list-wrapper
            *tuiDataList
            [items]="items"
            [itemContent]="(universitySearch.stringify$ | async)!"
          ></tui-data-list-wrapper>
        </tui-combo-box>

        <tui-error
          formControlName="enrolledUniversities"
          [error]="[] | tuiFieldError | async"
        ></tui-error>
      </label>

      <h3 class="tui-form__header">
        {{ 'CHANGE_PASSWORD' | translate }}
      </h3>

      <label
        [tuiLabel]="'NEW_PASSWORD' | translate"
        class="tui-form__row _optional"
      >
        <tui-input-password
          formControlName="password"
          tuiTextfieldSize="m"
          [tuiTextfieldLabelOutside]="true"
          [readOnly]="readOnly"
        >
          <input tuiTextfield type="password" autocomplete="new-password" />
        </tui-input-password>
        <div class="tui-form__field-note">
          {{ 'FILL_ONLY_IN_ORDER_TO_CHANGE_PASSWORD' | translate }}
        </div>
        <tui-error
          formControlName="password"
          [error]="[] | tuiFieldError | async"
        ></tui-error>
      </label>

      <div
        class="tui-form__buttons tui-form__buttons_align_end"
        *ngIf="item !== null"
      >
        <a
          [routerLink]="['..']"
          tuiButton
          type="button"
          appearance="flat"
          size="m"
          class="tui-form__button"
        >
          {{ 'CANCEL' | translate }}
        </a>
        <button
          tuiButton
          size="m"
          type="submit"
          class="tui-form__button"
          [disabled]="readOnly"
          [showLoader]="(handler.loading$ | async) ?? false"
        >
          {{ 'SAVE' | translate }}
        </button>
      </div>
    </form>
  </ng-container>
</ng-container>
